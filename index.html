<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Face Recognition App</title>
<script src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>
<style>
  :root {
    --accent:#06b6d4;
    --dark:#0f172a;
    --card:#1e293b;
    --text:#f1f5f9;
  }
  * { box-sizing: border-box; }
  body {
    margin:0; font-family: "Inter", system-ui, sans-serif;
    background:var(--dark); color:var(--text);
    display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
    padding:10px;
  }
  h1 { font-size:1.5rem; margin:10px 0; text-align:center; color:var(--accent); }
  .container {
    display:flex; flex-wrap:wrap;
    justify-content:center; gap:10px; width:100%;
    max-width:900px;
  }
  .panel {
    background:var(--card); padding:10px; border-radius:10px;
    flex:1 1 400px; min-width:300px;
  }
  video, canvas {
    width:100%; border-radius:10px; background:black;
    max-width:100%; height:auto;
  }
  .controls {
    display:flex; flex-wrap:wrap; gap:6px; justify-content:center; margin-top:10px;
  }
  .btn {
    flex:1 1 40%;
    padding:10px; font-weight:600; border:none; border-radius:8px;
    cursor:pointer; color:var(--dark); background:var(--accent);
    transition:0.2s;
  }
  .btn.secondary {
    background:#334155; color:var(--text);
  }
  .btn:active { transform:scale(0.98); }
  input[type=file] { display:none; }
  .people {
    margin-top:10px; max-height:200px; overflow:auto; background:#0f172a;
    padding:8px; border-radius:6px;
  }
  .person {
    display:flex; justify-content:space-between;
    align-items:center; margin:4px 0; font-size:0.9rem;
    background:#1e293b; padding:6px 8px; border-radius:6px;
  }
  #labelName {
    width:100%; padding:8px; border-radius:8px; border:none; margin-top:6px;
  }
  #rawData {
    width:100%; height:100px; border-radius:8px;
    background:#0f172a; color:#94a3b8; margin-top:6px; padding:6px;
  }
  @media(max-width:700px) {
    .container { flex-direction:column; align-items:stretch; }
    .btn { flex:1 1 45%; }
  }
</style>
</head>
<body>
  <h1>ðŸ§  Face Recognition App</h1>
  <div class="container">
    <div class="panel">
      <video id="video" autoplay muted playsinline></video>
      <canvas id="overlay"></canvas>
      <div class="controls">
        <button class="btn" id="startBtn">Start Camera</button>
        <button class="btn secondary" id="stopBtn">Stop</button>
        <label for="fileInput" class="btn secondary">Upload Image</label>
        <input type="file" id="fileInput" accept="image/*" multiple>
        <button class="btn secondary" id="captureBtn">Capture</button>
      </div>
    </div>
    <div class="panel">
      <input id="labelName" placeholder="Enter name (e.g. Alice)">
      <button class="btn" id="registerBtn">Register</button>
      <div class="controls">
        <button class="btn secondary" id="exportBtn">Export</button>
        <button class="btn secondary" id="importBtn">Import</button>
        <input type="file" id="importInput" accept="application/json">
        <button class="btn secondary" id="clearBtn">Clear</button>
      </div>
      <div class="people" id="peopleList"></div>
      <textarea id="rawData" readonly placeholder="Exported JSON data..."></textarea>
    </div>
  </div>

<script>
(async () => {
  const MODEL_URL = './models';
  const video = document.getElementById('video');
  const overlay = document.getElementById('overlay');
  const ctx = overlay.getContext('2d');
  const fileInput = document.getElementById('fileInput');
  const labelName = document.getElementById('labelName');
  const registerBtn = document.getElementById('registerBtn');
  const peopleList = document.getElementById('peopleList');
  const rawData = document.getElementById('rawData');
  const importInput = document.getElementById('importInput');

  let stream, running=false, lastDescriptor=null;
  let labeledData = JSON.parse(localStorage.getItem('faces')||'{}');

  // Load face-api models
  await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);
  await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
  await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);

  function updateList(){
    peopleList.innerHTML = '';
    Object.entries(labeledData).forEach(([name,desc])=>{
      const div=document.createElement('div');
      div.className='person';
      div.innerHTML=`<span>${name} (${desc.length})</span>
      <button class="btn secondary" style="padding:4px;" data-name="${name}">ðŸ—‘</button>`;
      peopleList.appendChild(div);
    });
    rawData.value=JSON.stringify(labeledData,null,2);
    peopleList.querySelectorAll('button[data-name]').forEach(b=>{
      b.onclick=()=>{
        delete labeledData[b.dataset.name];
        save(); updateList();
      }
    });
  }
  function save(){localStorage.setItem('faces',JSON.stringify(labeledData));}

  document.getElementById('startBtn').onclick=async()=>{
    if(running)return;
    stream=await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject=stream;
    running=true;
    detectLoop();
  };
  document.getElementById('stopBtn').onclick=()=>{
    if(stream)stream.getTracks().forEach(t=>t.stop());
    running=false; ctx.clearRect(0,0,overlay.width,overlay.height);
  };

  async function detectLoop(){
    overlay.width=video.videoWidth; overlay.height=video.videoHeight;
    const labeledDescriptors = Object.entries(labeledData).map(([n,arr])=>
      new faceapi.LabeledFaceDescriptors(n, arr.map(a=>new Float32Array(a))));
    const matcher = new faceapi.FaceMatcher(labeledDescriptors,0.55);
    const dets = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
    ctx.clearRect(0,0,overlay.width,overlay.height);
    dets.forEach(d=>{
      const box=d.detection.box;
      const best=matcher.findBestMatch(d.descriptor);
      ctx.strokeStyle='#06b6d4'; ctx.lineWidth=2;
      ctx.strokeRect(box.x,box.y,box.width,box.height);
      ctx.fillStyle='#06b6d4'; ctx.font='14px sans-serif';
      ctx.fillText(best.toString(),box.x,box.y-5);
    });
    if(running)requestAnimationFrame(detectLoop);
  }

  async function extractDescriptor(img){
    const det = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
    return det ? Array.from(det.descriptor) : null;
  }

  fileInput.onchange=async(e)=>{
    const files=[...e.target.files];
    for(const f of files){
      const img=new Image();
      img.src=URL.createObjectURL(f);
      await img.decode();
      lastDescriptor=await extractDescriptor(img);
      if(!lastDescriptor)alert('No face detected in '+f.name);
      else alert('Face captured! Enter name and click Register.');
    }
  };

  document.getElementById('captureBtn').onclick=async()=>{
    const c=document.createElement('canvas');
    c.width=video.videoWidth; c.height=video.videoHeight;
    c.getContext('2d').drawImage(video,0,0);
    const img=new Image();
    img.src=c.toDataURL(); await img.decode();
    lastDescriptor=await extractDescriptor(img);
    if(lastDescriptor) alert('Face captured! Now enter name and click Register.');
    else alert('No face detected.');
  };

  registerBtn.onclick=()=>{
    const name=labelName.value.trim();
    if(!name||!lastDescriptor)return alert('Enter name and capture/upload first.');
    labeledData[name]=labeledData[name]||[];
    labeledData[name].push(lastDescriptor);
    save(); updateList();
    labelName.value=''; lastDescriptor=null;
    alert('Registered '+name);
  };

  document.getElementById('exportBtn').onclick=()=>{
    const blob=new Blob([JSON.stringify(labeledData)],{type:'application/json'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download='faces.json'; a.click();
  };

  document.getElementById('importBtn').onclick=()=>importInput.click();
  importInput.onchange=async(e)=>{
    const txt=await e.target.files[0].text();
    try{labeledData=JSON.parse(txt); save(); updateList(); alert('Imported!');}
    catch{alert('Invalid JSON');}
  };

  document.getElementById('clearBtn').onclick=()=>{
    if(confirm('Clear all saved data?')){
      labeledData={}; save(); updateList();
    }
  };

  updateList();
})();
</script>
</body>
</html>
